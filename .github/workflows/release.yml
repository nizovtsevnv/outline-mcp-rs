name: Release Build

on:
  release:
    types: [published]
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

permissions:
  contents: write
  packages: write
  pull-requests: read

jobs:
  build-releases:
    name: Build Release Binaries  
    strategy:
      matrix:
        include:
          - target: x86_64-unknown-linux-gnu
            name: linux-x86_64
            nix-package: default
            binary: outline-mcp
            os: ubuntu-latest
          - target: x86_64-unknown-linux-musl
            name: linux-x86_64-musl
            nix-package: musl
            binary: outline-mcp
            os: ubuntu-latest
          - target: x86_64-unknown-linux-gnu
            name: linux-x86_64-glibc-optimized
            nix-package: glibc-optimized
            binary: outline-mcp
            os: ubuntu-latest
          - target: x86_64-pc-windows-gnu
            name: windows-x86_64
            nix-package: windows
            binary: outline-mcp.exe
            os: ubuntu-latest
          - target: x86_64-apple-darwin
            name: macos-x86_64
            nix-package: default  # Use native build on Intel runner
            binary: outline-mcp
            os: macos-13  # Intel runner
          - target: aarch64-apple-darwin
            name: macos-arm64
            nix-package: default  # Use native build on ARM runner  
            binary: outline-mcp
            os: macos-14  # ARM runner
    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v27
        with:
          nix_path: nixpkgs=channel:nixos-unstable
          extra_nix_config: |
            experimental-features = nix-command flakes
            accept-flake-config = true
            # Release build optimizations
            max-jobs = auto
            cores = 0
            system-features = nixos-test benchmark big-parallel kvm

      - name: Setup Nix cache
        uses: cachix/cachix-action@v15
        with:
          name: nix-community
          authToken: '${{ secrets.CACHIX_AUTH_TOKEN }}'
        continue-on-error: true

      - name: Setup additional caches (macOS)
        if: contains(matrix.os, 'macos')
        run: |
          # Additional caches for better Darwin/macOS support
          echo "extra-substituters = https://cuda-maintainers.cachix.org https://nixpkgs-update.cachix.org https://cache.iog.io" >> ~/.config/nix/nix.conf
          echo "extra-trusted-public-keys = cuda-maintainers.cachix.org-1:0dq3bujKpuEPiCgBV6oLvPQP4Q5qLu4YZnhQHUFSjlg= nixpkgs-update.cachix.org-1:P6GfVQwHyOr7iZMg2ELdDJnA5ELFWgp2zyWKj9gv8R4= hydra.iohk.io:f/Ea+s+dFdN+3Y/G+FDgSq+a5NEWhJGzdjvKNGv0/EQ=" >> ~/.config/nix/nix.conf
          
          # Aggressive optimizations for faster builds on macOS
          echo "max-jobs = 4" >> ~/.config/nix/nix.conf
          echo "cores = 0" >> ~/.config/nix/nix.conf
          echo "build-cores = 4" >> ~/.config/nix/nix.conf
          echo "narinfo-cache-negative-ttl = 0" >> ~/.config/nix/nix.conf
          echo "connect-timeout = 5" >> ~/.config/nix/nix.conf
          echo "stalled-download-timeout = 5" >> ~/.config/nix/nix.conf
          echo "keep-outputs = true" >> ~/.config/nix/nix.conf
          echo "keep-derivations = true" >> ~/.config/nix/nix.conf
          echo "builders-use-substitutes = true" >> ~/.config/nix/nix.conf

      # Cache Nix store for macOS builds (aggressive caching)
      - name: Cache Nix store (macOS only)
        if: contains(matrix.os, 'macos')
        uses: actions/cache@v4
        with:
          path: |
            /nix/store
            ~/.cache/nix
          key: nix-store-${{ matrix.target }}-${{ hashFiles('flake.lock', 'Cargo.lock') }}
          restore-keys: |
            nix-store-${{ matrix.target }}-
            nix-store-
            
      # Cache Rust dependencies for release builds
      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
          key: ${{ runner.os }}-${{ matrix.target }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-${{ matrix.target }}-cargo-
            ${{ runner.os }}-cargo-

      - name: Cache target directory
        uses: actions/cache@v4
        with:
          path: target/
          key: ${{ runner.os }}-${{ matrix.target }}-target-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-${{ matrix.target }}-target-
            ${{ runner.os }}-target-  # ÐÐµ Ð±Ð»Ð¾ÐºÐ¸Ñ€ÑƒÐµÐ¼ ÑÐ±Ð¾Ñ€ÐºÑƒ ÐµÑÐ»Ð¸ ÐºÐµÑˆ Ð½ÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½

      # Pre-fetch dependencies for macOS to improve cache efficiency
      - name: Pre-fetch dependencies (macOS only)
        if: contains(matrix.os, 'macos')
        run: |
          echo "Pre-fetching dependencies to improve build performance..."
          # This downloads dependencies without building, allowing better caching
          nix develop --command echo "Development environment ready"
          
      - name: Verify cargoHash is up to date
        run: |
          echo "ðŸ” Verifying cargoHash for release build..."
          if ! nix build 2>/dev/null; then
            echo "âŒ Cannot build release: cargoHash is outdated!"
            echo "Please run ./scripts/update-cargo-hash.sh locally and push changes."
            exit 1
          fi
          echo "âœ… cargoHash verified for release"

      - name: Build binary
        run: |
          echo "Building for target: ${{ matrix.target }}"
          if [[ "${{ matrix.os }}" == macos* ]]; then
            # macOS native build with optimizations
            echo "Using native macOS build with optimizations..."
            nix build . --cores 0 --max-jobs 4 --option build-cores 4
          elif [ "${{ matrix.nix-package }}" = "default" ]; then
            nix build .
          else
            nix build .#${{ matrix.nix-package }}
          fi

      - name: Sign Windows binary (if certificate available)
        if: matrix.target == 'x86_64-pc-windows-gnu' && runner.os == 'Linux'
        shell: bash
        run: |
          # Ð‘ÑƒÐ´ÑƒÑ‰Ð°Ñ Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶ÐºÐ° Windows signing Ñ‡ÐµÑ€ÐµÐ· osslsigncode
          # Ð¢Ñ€ÐµÐ±ÑƒÐµÑ‚ ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚ Ð² secrets: WINDOWS_CERTIFICATE, WINDOWS_CERTIFICATE_PASSWORD
          if [ ! -z "${{ secrets.WINDOWS_CERTIFICATE }}" ]; then
            echo "Windows signing certificate detected, but signing is not implemented yet"
            echo "To enable: install osslsigncode and configure certificate secrets"
            # sudo apt-get install osslsigncode
            # echo "${{ secrets.WINDOWS_CERTIFICATE }}" | base64 -d > cert.p12
            # osslsigncode sign -pkcs12 cert.p12 -pass "${{ secrets.WINDOWS_CERTIFICATE_PASSWORD }}" \
            #   -n "Outline MCP Server" -i "https://github.com/nizovtsevnv/outline-mcp-rs" \
            #   -in result/bin/outline-mcp.exe -out result/bin/outline-mcp-signed.exe
            # mv result/bin/outline-mcp-signed.exe result/bin/outline-mcp.exe
          fi

      - name: Prepare artifacts
        run: |
          # Create flat artifact structure (no platform subfolders)
          mkdir -p artifacts
          
          # Copy binary with simple name
          if [ "${{ matrix.target }}" = "x86_64-pc-windows-gnu" ]; then
            cp result/bin/outline-mcp.exe artifacts/outline-mcp.exe
          else
            cp result/bin/outline-mcp artifacts/outline-mcp
            chmod +x artifacts/outline-mcp
          fi
          
          # Create checksums (cross-platform)
          cd artifacts
          if command -v sha256sum >/dev/null 2>&1; then
            sha256sum ${{ matrix.binary }} > ${{ matrix.binary }}.sha256
          elif command -v shasum >/dev/null 2>&1; then
            shasum -a 256 ${{ matrix.binary }} > ${{ matrix.binary }}.sha256
          else
            echo "No SHA256 utility found" >&2
            exit 1
          fi
          
          # Create info file
          cat > README.txt << EOF
          Outline MCP Server - ${{ matrix.name }}
          =====================================
          
          Target: ${{ matrix.target }}
          Binary: ${{ matrix.binary }}
          
          Usage:
            ./outline-mcp --help
          
          Environment variables:
            OUTLINE_API_KEY     - Your Outline API key (required)
            OUTLINE_API_URL     - Outline instance URL (optional)
            HTTP_HOST          - HTTP server host (default: 127.0.0.1)
            HTTP_PORT          - HTTP server port (default: 3000)
          
          More info: https://github.com/nizovtsevnv/outline-mcp-rs
          EOF

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: outline-mcp-${{ matrix.name }}
          path: artifacts/
          retention-days: 30

  create-release:
    name: Create GitHub Release
    needs: build-releases
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-artifacts

      - name: Prepare release files
        run: |
          mkdir -p release
          
          # Create archives directly from artifact contents (flat structure)
          cd release-artifacts
          for artifact_dir in outline-mcp-*/; do
            platform=$(basename "$artifact_dir")
            echo "Creating archive for $platform..."
            
            cd "$artifact_dir"
            if [[ "$platform" == *"windows"* ]]; then
              # Create ZIP for Windows (flat structure)
              zip -r "../../release/${platform}.zip" *
            else
              # Ensure executable permissions are set before archiving
              chmod +x outline-mcp 2>/dev/null || true
              # Create tar.gz for Unix-like systems (flat structure, preserve permissions)
              tar -czf "../../release/${platform}.tar.gz" *
            fi
            cd ..
          done
          
          cd ../release
          ls -la

      - name: Extract release info
        id: release_info
        run: |
          # Extract version from tag (remove refs/tags/ and optional v prefix)
          TAG_NAME=${GITHUB_REF#refs/tags/}
          VERSION=${TAG_NAME#v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
          
          # Generate release notes
          echo "## ðŸš€ Release $VERSION" > RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md
          echo "### ðŸ“¦ Downloads" >> RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md
          echo "Each archive contains the \`outline-mcp\` binary (or \`outline-mcp.exe\` for Windows) with checksums and usage instructions." >> RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md
          echo "| Platform | Archive | Binary Inside |" >> RELEASE_NOTES.md
          echo "|----------|---------|---------------|" >> RELEASE_NOTES.md
          echo "| Linux x86_64 | [outline-mcp-linux-x86_64.tar.gz](https://github.com/nizovtsevnv/outline-mcp-rs/releases/download/$TAG_NAME/outline-mcp-linux-x86_64.tar.gz) | \`outline-mcp\` |" >> RELEASE_NOTES.md
          echo "| Linux x86_64 (musl static) | [outline-mcp-linux-x86_64-musl.tar.gz](https://github.com/nizovtsevnv/outline-mcp-rs/releases/download/$TAG_NAME/outline-mcp-linux-x86_64-musl.tar.gz) | \`outline-mcp\` |" >> RELEASE_NOTES.md
          echo "| Windows x86_64 | [outline-mcp-windows-x86_64.zip](https://github.com/nizovtsevnv/outline-mcp-rs/releases/download/$TAG_NAME/outline-mcp-windows-x86_64.zip) | \`outline-mcp.exe\` |" >> RELEASE_NOTES.md
          echo "| macOS x86_64 (Intel) | [outline-mcp-macos-x86_64.tar.gz](https://github.com/nizovtsevnv/outline-mcp-rs/releases/download/$TAG_NAME/outline-mcp-macos-x86_64.tar.gz) | \`outline-mcp\` |" >> RELEASE_NOTES.md
          echo "| macOS ARM64 (Apple Silicon) | [outline-mcp-macos-arm64.tar.gz](https://github.com/nizovtsevnv/outline-mcp-rs/releases/download/$TAG_NAME/outline-mcp-macos-arm64.tar.gz) | \`outline-mcp\` |" >> RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md
          echo "### âœ¨ Features" >> RELEASE_NOTES.md
          echo "- ðŸ”— MCP server for Outline knowledge base" >> RELEASE_NOTES.md
          echo "- ðŸ“¡ STDIO and HTTP transport support" >> RELEASE_NOTES.md
          echo "- ðŸ› ï¸ Complete document, collection, and user management" >> RELEASE_NOTES.md
          echo "- ðŸ§ Static musl build for maximum portability" >> RELEASE_NOTES.md
          echo "- ðŸªŸ Windows cross-compilation support" >> RELEASE_NOTES.md

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: release/*
          body_path: RELEASE_NOTES.md
          tag_name: ${{ steps.release_info.outputs.tag_name }}
          name: Release ${{ steps.release_info.outputs.version }}
          draft: false
          prerelease: false
          token: ${{ secrets.GITHUB_TOKEN }}